<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buffett Stock Research PWA</title>
    <link rel="icon" href="https://i.imgur.com/8p5Y7Zv.png" sizes="192x192">
    <link rel="apple-touch-icon" href="https://i.imgur.com/8p5Y7Zv.png">
    <meta name="theme-color" content="#007bff">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <!-- Inline Manifest for PWA -->
    <script>
        const manifest = {
            "short_name": "Buffett Research",
            "name": "Warren Buffett Stock Research PWA",
            "icons": [
                { "src": "https://i.imgur.com/8p5Y7Zv.png", "type": "image/png", "sizes": "192x192" },
                { "src": "https://i.imgur.com/8p5Y7Zv.png", "type": "image/png", "sizes": "512x512" }
            ],
            "start_url": "/",
            "background_color": "#ffffff",
            "theme_color": "#007bff",
            "display": "standalone"
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(blob);
        document.head.innerHTML += `<link rel="manifest" href="${manifestURL}">`;
    </script>

    <!-- Inline CSS -->
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            margin: 0;
            padding: 15px;
        }
        .container {
            max-width: 100%;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
        }
        h1 {
            text-align: center;
            color: #007bff;
            font-weight: 700;
            font-size: 1.8em;
            margin-bottom: 15px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        #analyzeBtn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            transition: all 0.3s ease;
            font-size: 1.1em;
            padding: 10px;
        }
        #analyzeBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
        }
        #result {
            margin-top: 20px;
        }
        .card {
            border: none;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        .nav-tabs .nav-link {
            font-size: 0.9em;
            padding: 8px 12px;
        }
        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .tab-content {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
        }
        .list-group-item {
            font-size: 0.9em;
            padding: 8px 12px;
        }
        .badge {
            font-size: 0.9em;
            padding: 6px 10px;
        }
        .spinner {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        #tradingview-chart {
            height: 400px;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
        }
        #searchResults {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        .news-item {
            margin-bottom: 15px;
            padding: 12px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .news-title a {
            font-weight: bold;
            color: #007bff;
            text-decoration: none;
            font-size: 0.9em;
        }
        .news-title a:hover {
            text-decoration: underline;
        }
        .news-summary, .news-sentiment {
            font-size: 0.85em;
            color: #555;
            margin-top: 8px;
        }
        .peer-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .peer-item {
            background: #e9ecef;
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 0.85em;
        }
        @media (max-width: 576px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 1.5em;
            }
            #analyzeBtn {
                font-size: 1em;
                padding: 8px;
            }
            #tradingview-chart {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-search-dollar me-2"></i>Buffett Stock Research</h1>
        <p class="text-muted text-center" style="font-size: 0.9em;">Analyze Indian stocks (BSE recommended) using Warren Buffett's principles. Enter symbol (e.g., RELIANCE.BSE) or search by name.</p>
        
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="stockSymbol" placeholder="Enter symbol or name (e.g., RELIANCE.BSE)" required>
        </div>
        <div id="searchResults" class="list-group"></div>
        <div class="input-group">
            <label class="input-group-text"><i class="fas fa-exchange-alt"></i> Exchange</label>
            <select class="form-select" id="exchange">
                <option value="BSE">BSE (e.g., RELIANCE.BSE)</option>
                <option value="NSE">NSE (e.g., RELIANCE.NS)</option>
            </select>
        </div>
        <button class="btn btn-primary w-100" id="analyzeBtn"><i class="fas fa-analyze me-2"></i>Research Stock</button>
        
        <div class="spinner" id="spinner">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted">Researching...</p>
        </div>
        
        <div id="result"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- TradingView Widget -->
    <script src="https://s3.tradingview.com/tv.js"></script>

    <!-- Inline JavaScript -->
    <script>
        const apiKey = 'WRSPEAQQ1P7XX0Q9'; // Your Alpha Vantage API key

        // Service Worker
        const swCode = `
            self.addEventListener('install', (event) => {
                event.waitUntil(
                    caches.open('buffett-research-v1').then((cache) => {
                        return cache.addAll([
                            '/',
                            '/index.html'
                        ]);
                    })
                );
            });

            self.addEventListener('fetch', (event) => {
                event.respondWith(
                    caches.match(event.request).then((response) => {
                        return response || fetch(event.request);
                    })
                );
            });
        `;
        const swBlob = new Blob([swCode], { type: 'application/javascript' });
        const swURL = URL.createObjectURL(swBlob);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swURL)
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        // Symbol Search
        const stockSymbolInput = document.getElementById('stockSymbol');
        const searchResults = document.getElementById('searchResults');
        stockSymbolInput.addEventListener('input', async () => {
            const query = stockSymbolInput.value.trim();
            const exchange = document.getElementById('exchange').value;
            if (query.length < 3) {
                searchResults.innerHTML = '';
                return;
            }
            try {
                const res = await fetch(`https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords=${encodeURIComponent(query)}&apikey=${apiKey}`);
                const data = await res.json();
                if (data.bestMatches && data.bestMatches.length) {
                    searchResults.innerHTML = data.bestMatches
                        .filter(match => match['3. type'] === 'Equity' && (match['4. region'] === 'India' || match['1. symbol'].endsWith(`.${exchange}`)))
                        .map(match => `<a href="#" class="list-group-item list-group-item-action" data-symbol="${match['1. symbol']}">${match['2. name']} (${match['1. symbol']})</a>`)
                        .join('');
                    searchResults.querySelectorAll('a').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            stockSymbolInput.value = link.dataset.symbol;
                            searchResults.innerHTML = '';
                        });
                    });
                } else {
                    searchResults.innerHTML = '<div class="list-group-item">No matching symbols found. Try BSE suffix (e.g., RELIANCE.BSE).</div>';
                }
            } catch (error) {
                searchResults.innerHTML = `<div class="list-group-item text-danger">Error searching: ${error.message}. Check rate limits (5/min, 500/day).</div>`;
            }
        });

        // Stock Analysis
        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            const symbolInput = document.getElementById('stockSymbol').value.trim();
            const exchange = document.getElementById('exchange').value;
            const resultDiv = document.getElementById('result');
            const spinner = document.getElementById('spinner');
            
            if (!symbolInput) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please enter a stock symbol.</div>';
                return;
            }

            // Append exchange suffix
            let symbol = symbolInput;
            const suffix = exchange === 'BSE' ? '.BSE' : '.NS';
            if (!symbol.endsWith('.BSE') && !symbol.endsWith('.NS')) {
                symbol = `${symbol}${suffix}`;
            } else if (symbol.endsWith('.NS') && exchange === 'BSE') {
                symbol = symbol.replace('.NS', '.BSE');
            } else if (symbol.endsWith('.BSE') && exchange === 'NSE') {
                symbol = symbol.replace('.BSE', '.NS');
            }
            
            resultDiv.innerHTML = '';
            spinner.style.display = 'block';
            searchResults.innerHTML = '';
            
            try {
                // Fetch data with rate limit handling
                const overviewRes = await fetch(`https://www.alphavantage.co/query?function=OVERVIEW&symbol=${symbol}&apikey=${apiKey}`);
                const overview = await overviewRes.json();
                
                if (!overview.Symbol || overview.Symbol === 'None' || overview.Error) {
                    throw new Error('Invalid symbol or no data. Try BSE (e.g., RELIANCE.BSE) or search above.');
                }
                
                const incomeRes = await fetch(`https://www.alphavantage.co/query?function=INCOME_STATEMENT&symbol=${symbol}&apikey=${apiKey}`);
                const income = await incomeRes.json();
                
                const balanceRes = await fetch(`https://www.alphavantage.co/query?function=BALANCE_SHEET&symbol=${symbol}&apikey=${apiKey}`);
                const balance = await balanceRes.json();
                
                const newsRes = await fetch(`https://www.alphavantage.co/query?function=NEWS_SENTIMENT&tickers=${symbol.replace(/\..*/,'')}&apikey=${apiKey}`);
                const news = await newsRes.json();
                
                // Extract metrics
                const name = overview.Name || 'N/A';
                const description = overview.Description || 'N/A';
                const sector = overview.Sector || 'N/A';
                const peRatio = parseFloat(overview.PERatio) || 'N/A';
                const pbRatio = parseFloat(overview.PriceToBookRatio) || 'N/A';
                const roe = parseFloat(overview.ReturnOnEquityTTM) || 'N/A';
                const debtToEquity = parseFloat(overview.DebtEquityRatio) || 'N/A';
                const epsTTM = parseFloat(overview.EPSTTM) || 'N/A';
                const currentPrice = parseFloat(overview.AnalystTargetPrice) || parseFloat(overview['50DayMovingAverage']) || 'N/A';
                
                // Earnings growth
                let growthRate = 'N/A';
                if (income.annualReports && income.annualReports.length >= 5) {
                    const epsYears = income.annualReports.slice(0, 5).map(report => parseFloat(report.dilutedEPS));
                    const growthRates = [];
                    for (let i = 1; i < epsYears.length; i++) {
                        if (epsYears[i-1] !== 0) {
                            growthRates.push((epsYears[i] - epsYears[i-1]) / Math.abs(epsYears[i-1]) * 100);
                        }
                    }
                    growthRate = growthRates.length > 0 ? (growthRates.reduce((a, b) => a + b, 0) / growthRates.length).toFixed(2) : 'N/A';
                }
                
                // Intrinsic value
                let intrinsicValue = 'N/A';
                if (epsTTM !== 'N/A' && growthRate !== 'N/A') {
                    const g = parseFloat(growthRate) / 100;
                    const bondYield = 7;
                    intrinsicValue = (epsTTM * (8.5 + 2 * g * 100) * 4.4 / bondYield).toFixed(2);
                }
                
                // Margin of safety
                let marginOfSafety = 'N/A';
                if (currentPrice !== 'N/A' && intrinsicValue !== 'N/A') {
                    marginOfSafety = currentPrice < (intrinsicValue * 0.75) ? 'Good margin' : 'Insufficient margin';
                }
                
                // Buffett Score
                let score = 0;
                let analysis = '';
                if (roe > 15) { score += 2; analysis += '<li class="list-group-item"><i class="fas fa-check-circle text-success"></i> High ROE: Good.</li>'; } else { analysis += '<li class="list-group-item"><i class="fas fa-times-circle text-danger"></i> ROE: Needs improvement.</li>'; }
                if (debtToEquity < 0.5) { score += 2; analysis += '<li class="list-group-item"><i class="fas fa-check-circle text-success"></i> Low Debt/Equity: Strong.</li>'; } else { analysis += '<li class="list-group-item"><i class="fas fa-times-circle text-danger"></i> Debt/Equity: High.</li>'; }
                if (peRatio < 15) { score += 1; analysis += '<li class="list-group-item"><i class="fas fa-check-circle text-success"></i> Low P/E: Undervalued.</li>'; } else { analysis += '<li class="list-group-item"><i class="fas fa-times-circle text-danger"></i> P/E: Overvalued.</li>'; }
                if (growthRate > 5) { score += 1; analysis += '<li class="list-group-item"><i class="fas fa-check-circle text-success"></i> Consistent growth: Positive.</li>'; } else { analysis += '<li class="list-group-item"><i class="fas fa-times-circle text-danger"></i> Growth: Lacking.</li>'; }
                const moatKeywords = ['leader', 'dominant', 'brand', 'patent', 'network', 'scale'];
                const hasMoat = moatKeywords.some(word => description.toLowerCase().includes(word));
                if (hasMoat) { score += 2; analysis += '<li class="list-group-item"><i class="fas fa-check-circle text-success"></i> Economic moat detected.</li>'; } else { analysis += '<li class="list-group-item"><i class="fas fa-times-circle text-danger"></i> Moat: Not evident.</li>'; }
                
                // Suggestion
                let suggestion = '';
                let badgeClass = '';
                if (score >= 6) { suggestion = 'Strong Buy'; badgeClass = 'bg-success'; }
                else if (score >= 4) { suggestion = 'Hold/Buy'; badgeClass = 'bg-warning'; }
                else { suggestion = 'Avoid/Sell'; badgeClass = 'bg-danger'; }
                
                // Financial Tables
                let incomeTable = '<table><thead><tr><th>Year</th><th>Revenue (Cr)</th><th>Net Income (Cr)</th><th>EPS</th></tr></thead><tbody>';
                if (income.annualReports) {
                    income.annualReports.slice(0, 5).forEach(report => {
                        incomeTable += `<tr><td>${report.fiscalDateEnding}</td><td>${(parseFloat(report.totalRevenue) / 1e7).toFixed(2)}</td><td>${(parseFloat(report.netIncome) / 1e7).toFixed(2)}</td><td>${report.dilutedEPS}</td></tr>`;
                    });
                }
                incomeTable += '</tbody></table>';
                
                let balanceTable = '<table><thead><tr><th>Year</th><th>Assets (Cr)</th><th>Liabilities (Cr)</th><th>Equity (Cr)</th></tr></thead><tbody>';
                if (balance.annualReports) {
                    balance.annualReports.slice(0, 5).forEach(report => {
                        balanceTable += `<tr><td>${report.fiscalDateEnding}</td><td>${(parseFloat(report.totalAssets) / 1e7).toFixed(2)}</td><td>${(parseFloat(report.totalLiabilities) / 1e7).toFixed(2)}</td><td>${(parseFloat(report.totalShareholderEquity) / 1e7).toFixed(2)}</td></tr>`;
                    });
                }
                balanceTable += '</tbody></table>';
                
                // News
                let newsSection = '';
                if (news.feed && news.feed.length) {
                    newsSection = news.feed.slice(0, 5).map(item => `
                        <div class="news-item">
                            <div class="news-title"><a href="${item.url}" target="_blank">${item.title}</a></div>
                            <div class="news-summary">${item.summary}</div>
                            <div class="news-sentiment">Sentiment: ${item.overall_sentiment_label} (Score: ${item.overall_sentiment_score})</div>
                        </div>`).join('');
                } else {
                    newsSection = '<p>No recent news available.</p>';
                }
                
                // Peers (mock, as Alpha Vantage doesn't provide peers)
                const peers = sector ? ['TCS.' + suffix, 'INFY.' + suffix, 'HDFCBANK.' + suffix].filter(p => p !== symbol) : [];
                
                // Render Tabs
                resultDiv.innerHTML = `
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="financials-tab" data-bs-toggle="tab" data-bs-target="#financials" type="button" role="tab">Financials</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="news-tab" data-bs-toggle="tab" data-bs-target="#news" type="button" role="tab">News</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart" type="button" role="tab">Chart</button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h4 class="mb-0">${name} (${symbol})</h4>
                                    <span class="badge ${badgeClass}">${suggestion}</span>
                                </div>
                                <div class="card-body">
                                    <p><strong>Sector:</strong> ${sector}</p>
                                    <p><strong>Description:</strong> ${description}</p>
                                    <h5>Key Metrics</h5>
                                    <ul class="list-group mb-3">
                                        <li class="list-group-item">ROE: ${roe}%</li>
                                        <li class="list-group-item">Debt/Equity: ${debtToEquity}</li>
                                        <li class="list-group-item">P/E Ratio: ${peRatio}</li>
                                        <li class="list-group-item">P/B Ratio: ${pbRatio}</li>
                                        <li class="list-group-item">EPS TTM: ${epsTTM}</li>
                                        <li class="list-group-item">Avg EPS Growth (5Y): ${growthRate}%</li>
                                        <li class="list-group-item">Intrinsic Value: ${intrinsicValue}</li>
                                        <li class="list-group-item">Current/Target Price: ${currentPrice}</li>
                                        <li class="list-group-item">Margin of Safety: ${marginOfSafety}</li>
                                    </ul>
                                    <h5>Buffett Analysis</h5>
                                    <ul class="list-group mb-3">${analysis}</ul>
                                    <h5>Peers</h5>
                                    <div class="peer-list">${peers.map(p => `<span class="peer-item">${p}</span>`).join('')}</div>
                                    <h5>Score: <span class="badge bg-primary">${score}/8</span></h5>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="financials" role="tabpanel">
                            <h5>Income Statement</h5>
                            ${incomeTable}
                            <h5 class="mt-4">Balance Sheet</h5>
                            ${balanceTable}
                        </div>
                        <div class="tab-pane fade" id="news" role="tabpanel">
                            <h5>Recent News & Sentiment</h5>
                            ${newsSection}
                        </div>
                        <div class="tab-pane fade" id="chart" role="tabpanel">
                            <div id="tradingview-chart"></div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3" style="font-size: 0.85em;">
                        <i class="fas fa-info-circle"></i> Not financial advice. BSE recommended due to NSE limitations. Wait 1–2 min if rate limit reached.
                    </div>
                `;
                
                // TradingView Chart
                const chartSymbol = symbol.replace('.BSE', '').replace('.NS', '');
                new TradingView.widget({
                    "container_id": "tradingview-chart",
                    "width": "100%",
                    "height": 400,
                    "symbol": symbol.endsWith('.NS') ? `NSE:${chartSymbol}` : `BSE:${chartSymbol}`,
                    "interval": "D",
                    "timezone": "Asia/Kolkata",
                    "theme": "light",
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "studies": ["BB@tv-basicstudies", "MACD@tv-basicstudies", "RSI@tv-basicstudies"],
                    "show_popup_button": true,
                    "popup_width": "1000",
                    "popup_height": "650"
                });
                
                spinner.style.display = 'none';
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger" style="font-size: 0.9em;">
                        Error: ${error.message}. Try:
                        <ul>
                            <li>Using BSE suffix (e.g., RELIANCE.BSE) or search above.</li>
                            <li>Waiting 1–2 min for rate limits (5/min, 500/day).</li>
                            <li>Checking internet or trying a US VPN.</li>
                            <li>Contact <a href="mailto:premium@alphavantage.co">Alpha Vantage support</a>.</li>
                        </ul>
                    </div>`;
                spinner.style.display = 'none';
            }
        });
    </script>
</body>
</html>