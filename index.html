<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buffett Stock Research PWA</title>
    <link rel="icon" href="icon-192.png" sizes="192x192">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#007bff">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <!-- Inline Manifest for PWA -->
    <script>
        const manifest = {
            "short_name": "Buffett Research",
            "name": "Warren Buffett Stock Research PWA",
            "icons": [
                { "src": "icon-192.png", "type": "image/png", "sizes": "192x192" },
                { "src": "icon-512.png", "type": "image/png", "sizes": "512x512" }
            ],
            "start_url": "/",
            "background_color": "#ffffff",
            "theme_color": "#007bff",
            "display": "standalone"
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(blob);
        document.head.innerHTML += `<link rel="manifest" href="${manifestURL}">`;
    </script>

    <!-- Inline CSS for Wonderful UI -->
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #007bff;
            font-weight: 700;
        }
        .input-group {
            margin-bottom: 20px;
        }
        #analyzeBtn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            transition: all 0.3s ease;
        }
        #analyzeBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }
        #result {
            margin-top: 30px;
        }
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .tab-content {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
        }
        .list-group-item {
            border: none;
        }
        .badge {
            font-size: 1em;
        }
        .spinner {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        #tradingview-chart {
            height: 500px;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        .news-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        .news-title {
            font-weight: bold;
            color: #007bff;
        }
        .news-summary {
            margin-top: 5px;
        }
        .news-sentiment {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-search-dollar me-2"></i>Buffett-Inspired Stock Research Tool</h1>
        <p class="text-muted text-center">Comprehensive research for Indian stocks (NSE/BSE) based on Warren Buffett's principles. Includes fundamentals, financials, news, and charts. Powered by Alpha Vantage API.</p>
        <p class="text-center">Enter symbol with .NS or .BSE (e.g., RELIANCE.NS or RELIANCE.BSE). BSE recommended for better support.</p>
        
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="stockSymbol" placeholder="Enter stock symbol (e.g., RELIANCE.NS)" required>
        </div>
        <button class="btn btn-primary w-100" id="analyzeBtn"><i class="fas fa-analyze me-2"></i>Research Stock</button>
        
        <div class="spinner" id="spinner">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted">Researching...</p>
        </div>
        
        <div id="result"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- TradingView Widget -->
    <script src="https://s3.tradingview.com/tv.js"></script>

    <!-- Inline JavaScript -->
    <script>
        const apiKey = 'WRSPEAQQ1P7XX0Q9';  // Your Alpha Vantage API key

        // Service Worker for PWA
        const swCode = `
            self.addEventListener('install', (event) => {
                event.waitUntil(
                    caches.open('buffett-research-v1').then((cache) => {
                        return cache.addAll([
                            '/',
                            '/index.html'
                        ]);
                    })
                );
            });

            self.addEventListener('fetch', (event) => {
                event.respondWith(
                    caches.match(event.request).then((response) => {
                        return response || fetch(event.request);
                    })
                );
            });
        `;
        const swBlob = new Blob([swCode], { type: 'application/javascript' });
        const swURL = URL.createObjectURL(swBlob);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swURL)
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            const symbol = document.getElementById('stockSymbol').value.trim();
            const resultDiv = document.getElementById('result');
            const spinner = document.getElementById('spinner');
            
            if (!symbol) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please enter a stock symbol.</div>';
                return;
            }
            
            resultDiv.innerHTML = '';
            spinner.style.display = 'block';
            
            try {
                // Fetch overview
                const overviewRes = await fetch(`https://www.alphavantage.co/query?function=OVERVIEW&symbol=${symbol}&apikey=${apiKey}`);
                const overview = await overviewRes.json();
                
                if (!overview.Symbol) {
                    throw new Error('Invalid symbol or no data available. Try BSE suffix (e.g., RELIANCE.BSE).');
                }
                
                // Fetch income statement
                const incomeRes = await fetch(`https://www.alphavantage.co/query?function=INCOME_STATEMENT&symbol=${symbol}&apikey=${apiKey}`);
                const income = await incomeRes.json();
                
                // Fetch balance sheet
                const balanceRes = await fetch(`https://www.alphavantage.co/query?function=BALANCE_SHEET&symbol=${symbol}&apikey=${apiKey}`);
                const balance = await balanceRes.json();
                
                // Fetch news
                const newsRes = await fetch(`https://www.alphavantage.co/query?function=NEWS_SENTIMENT&tickers=${symbol.replace(/\..*/,'')}&apikey=${apiKey}`);
                const news = await newsRes.json();
                
                // Extract metrics
                const name = overview.Name;
                const description = overview.Description;
                const sector = overview.Sector;
                const peRatio = parseFloat(overview.PERatio) || 'N/A';
                const pbRatio = parseFloat(overview.PriceToBookRatio) || 'N/A';
                const roe = parseFloat(overview.ReturnOnEquityTTM) || 'N/A';
                const debtToEquity = parseFloat(overview.DebtEquityRatio) || 'N/A';
                const epsTTM = parseFloat(overview.EPSTTM) || 'N/A';
                const currentPrice = parseFloat(overview.AnalystTargetPrice) || parseFloat(overview['50DayMovingAverage']) || 'N/A';
                
                // Earnings growth
                let growthRate = 'N/A';
                if (income.annualReports && income.annualReports.length >= 5) {
                    const epsYears = income.annualReports.slice(0, 5).map(report => parseFloat(report.dilutedEPS));
                    const growthRates = [];
                    for (let i = 1; i < epsYears.length; i++) {
                        if (epsYears[i-1] !== 0) {
                            growthRates.push((epsYears[i] - epsYears[i-1]) / Math.abs(epsYears[i-1]) * 100);
                        }
                    }
                    growthRate = growthRates.length > 0 ? (growthRates.reduce((a, b) => a + b, 0) / growthRates.length).toFixed(2) : 'N/A';
                }
                
                // Intrinsic value
                let intrinsicValue = 'N/A';
                if (epsTTM !== 'N/A' && growthRate !== 'N/A') {
                    const g = parseFloat(growthRate) / 100;
                    const bondYield = 7;
                    intrinsicValue = (epsTTM * (8.5 + 2 * g * 100) * 4.4 / bondYield).toFixed(2);
                }
                
                // Margin of safety
                let marginOfSafety = 'N/A';
                if (currentPrice !== 'N/A' && intrinsicValue !== 'N/A') {
                    marginOfSafety = currentPrice < (intrinsicValue * 0.75) ? 'Good margin' : 'Insufficient margin';
                }
                
                // Buffett Score
                let score = 0;
                let analysis = '';
                if (roe > 15) { score += 2; analysis += '<li class="list-group-item"><i class="fas fa-check-circle text-success"></i> High ROE: Good.</li>'; } else { analysis += '<li class="list-group-item"><i class="fas fa-times-circle text-danger"></i> ROE: Needs improvement.</li>'; }
                if (debtToEquity < 0.5) { score += 2; analysis += '<li class="list-group-item"><i class="fas fa-check-circle text-success"></i> Low Debt/Equity: Strong.</li>'; } else { analysis += '<li class="list-group-item"><i class="fas fa-times-circle text-danger"></i> Debt/Equity: High.</li>'; }
                if (peRatio < 15) { score += 1; analysis += '<li class="list-group-item"><i class="fas fa-check-circle text-success"></i> Low P/E: Undervalued.</li>'; } else { analysis += '<li class="list-group-item"><i class="fas fa-times-circle text-danger"></i> P/E: Overvalued.</li>'; }
                if (growthRate > 5) { score += 1; analysis += '<li class="list-group-item"><i class="fas fa-check-circle text-success"></i> Consistent growth: Positive.</li>'; } else { analysis += '<li class="list-group-item"><i class="fas fa-times-circle text-danger"></i> Growth: Lacking.</li>'; }
                const moatKeywords = ['leader', 'dominant', 'brand', 'patent', 'network', 'scale'];
                const hasMoat = moatKeywords.some(word => description.toLowerCase().includes(word));
                if (hasMoat) { score += 2; analysis += '<li class="list-group-item"><i class="fas fa-check-circle text-success"></i> Economic moat detected.</li>'; } else { analysis += '<li class="list-group-item"><i class="fas fa-times-circle text-danger"></i> Moat: Not evident.</li>'; }
                
                // Suggestion
                let suggestion = '';
                let badgeClass = '';
                if (score >= 6) { suggestion = 'Strong Buy'; badgeClass = 'bg-success'; }
                else if (score >= 4) { suggestion = 'Hold/Buy'; badgeClass = 'bg-warning'; }
                else { suggestion = 'Avoid/Sell'; badgeClass = 'bg-danger'; }
                
                // Financial Statements Tables
                let incomeTable = '<table><thead><tr><th>Year</th><th>Revenue</th><th>Net Income</th><th>EPS</th></tr></thead><tbody>';
                if (income.annualReports) {
                    income.annualReports.forEach(report => {
                        incomeTable += `<tr><td>${report.fiscalDateEnding}</td><td>${report.totalRevenue}</td><td>${report.netIncome}</td><td>${report.dilutedEPS}</td></tr>`;
                    });
                }
                incomeTable += '</tbody></table>';
                
                let balanceTable = '<table><thead><tr><th>Year</th><th>Total Assets</th><th>Total Liabilities</th><th>Equity</th></tr></thead><tbody>';
                if (balance.annualReports) {
                    balance.annualReports.forEach(report => {
                        balanceTable += `<tr><td>${report.fiscalDateEnding}</td><td>${report.totalAssets}</td><td>${report.totalLiabilities}</td><td>${report.totalShareholderEquity}</td></tr>`;
                    });
                }
                balanceTable += '</tbody></table>';
                
                // News
                let newsSection = '';
                if (news.feed) {
                    news.feed.slice(0, 5).forEach(item => {
                        newsSection += `
                            <div class="news-item">
                                <div class="news-title"><a href="${item.url}" target="_blank">${item.title}</a></div>
                                <div class="news-summary">${item.summary}</div>
                                <div class="news-sentiment">Sentiment: ${item.overall_sentiment_label} (Score: ${item.overall_sentiment_score})</div>
                            </div>`;
                    });
                } else {
                    newsSection = '<p>No recent news available.</p>';
                }
                
                // Display with Tabs
                resultDiv.innerHTML = `
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="financials-tab" data-bs-toggle="tab" data-bs-target="#financials" type="button" role="tab">Financials</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="news-tab" data-bs-toggle="tab" data-bs-target="#news" type="button" role="tab">News</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart" type="button" role="tab">Chart</button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h4 class="mb-0">${name} (${symbol})</h4>
                                    <span class="badge ${badgeClass}">${suggestion}</span>
                                </div>
                                <div class="card-body">
                                    <p><strong>Sector:</strong> ${sector}</p>
                                    <p><strong>Description:</strong> ${description}</p>
                                    <h5>Key Metrics</h5>
                                    <ul class="list-group mb-3">
                                        <li class="list-group-item">ROE: ${roe}%</li>
                                        <li class="list-group-item">Debt/Equity: ${debtToEquity}</li>
                                        <li class="list-group-item">P/E Ratio: ${peRatio}</li>
                                        <li class="list-group-item">P/B Ratio: ${pbRatio}</li>
                                        <li class="list-group-item">EPS TTM: ${epsTTM}</li>
                                        <li class="list-group-item">Avg EPS Growth (5Y): ${growthRate}%</li>
                                        <li class="list-group-item">Intrinsic Value: ${intrinsicValue}</li>
                                        <li class="list-group-item">Current/Target Price: ${currentPrice}</li>
                                        <li class="list-group-item">Margin of Safety: ${marginOfSafety}</li>
                                    </ul>
                                    <h5>Buffett Analysis</h5>
                                    <ul class="list-group mb-3">${analysis}</ul>
                                    <h5>Score: <span class="badge bg-primary">${score}/8</span></h5>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="financials" role="tabpanel">
                            <h5>Income Statement</h5>
                            ${incomeTable}
                            <h5 class="mt-4">Balance Sheet</h5>
                            ${balanceTable}
                        </div>
                        <div class="tab-pane fade" id="news" role="tabpanel">
                            <h5>Recent News & Sentiment</h5>
                            ${newsSection}
                        </div>
                        <div class="tab-pane fade" id="chart" role="tabpanel">
                            <div id="tradingview-chart"></div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i> Not financial advice. Do your own research.
                    </div>
                `;
                
                // TradingView Chart
                const chartSymbol = symbol.replace('.BSE', '').replace('.NS', '');
                new TradingView.widget({
                    "container_id": "tradingview-chart",
                    "width": "100%",
                    "height": 500,
                    "symbol": symbol.endsWith('.NS') ? `NSE:${chartSymbol}` : `BSE:${chartSymbol}`,
                    "interval": "D",
                    "timezone": "Asia/Kolkata",
                    "theme": "light",
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "studies": ["BB@tv-basicstudies", "MACD@tv-basicstudies", "RSI@tv-basicstudies"],
                    "show_popup_button": true,
                    "popup_width": "1000",
                    "popup_height": "650"
                });
                
                spinner.style.display = 'none';
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}. Check symbol, API key, or rate limits (5/min, 500/day). Try BSE suffix if NSE fails.</div>`;
                spinner.style.display = 'none';
            }
        });
    </script>
</body>
</html>